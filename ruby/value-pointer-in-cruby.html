<default!DOCTYPE html>
<html lang="en">
    <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
    
      What's VALUE in CRuby? &middot; Stabby Proc
    
  </title>

  <link href='https://fonts.googleapis.com/css?family=Ubuntu' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Inconsolata:700' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="https://cdn.rawgit.com/konpa/devicon/master/devicon.min.css">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?">

  <link rel="alternate" type="application/atom+xml" title="Stabby Proc" href="/atom.xml">
</head>

  <body>
    <div class="container content">
      <header class="masthead">
        <h2 class="masthead-title">
          <a href="/" title="Home">
            <img src="/public/stabby-proc-logo.png"/>
          </a>
        </h2>
        <span class="tagline">- "Taking a stab at this thing called blogging!"</span>
      </header>

      <main>
      <article class="post">
  <h1 class="post-title">What's VALUE in CRuby?</h1>
    <sub class="article-date">Feb-20-2017</sub>
    <div class="post-tags-list">
      <ul>
        
        <li><a href="http://stabbyproc.com/tags#cruby" class="post-tag">cruby</a></li>
        
        <li><a href="http://stabbyproc.com/tags#value-pointer" class="post-tag">value-pointer</a></li>
        
      </ul>
    </div>
    <p>Before I talk about CRuby, I want to briefly discuss what the VALUE pointer is. Understanding what this pointer does will help when looking through <a href="https://docs.ruby-lang.org/en/trunk/extension_rdoc.html">CRuby source code</a>. One great benefit about C is that every value and function must specifically declare the datatype that it’s working with. I find this super helpful when trying to investigate what something does in C code. By using this, it’s possible to determine the value type that the function uses, and what each parameter is before it’s used. This is different from Ruby or other dynamically typed languages, <a href="http://www.rubyfleebie.com/ruby-is-dynamically-and-strongly-typed/">where a function or variable data type is determined at runtime</a>. While this is helpful when you’re working with objects that don’t have a specific data type, in my opinion I prefer the declared value type as it makes the code easier to read and understand.</p>

<p>When I inspect C code, I always try to identify the data type to better understand what’s going on. The only problem with inspecting CRuby source code though, was I kept running into this VALUE data type:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">VALUE</span> <span class="nf">example_func</span><span class="p">(</span><span class="n">VALUE</span> <span class="n">arg_object</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">VALUE</span> <span class="n">var</span> <span class="o">=</span> <span class="n">another_example_func</span><span class="p">(</span><span class="n">arg_object</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">var</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>What’s this data type and how can I use it to better understand the CRuby source code? As I thought about this dilemma, I remembered reading about VALUE in a book I finished a while back, <a href="http://mgm702.com/books.html">Ruby Under a Microscope</a>. In this book the author, <a href="http://www.rubyinside.com/">Pat Shaughnessy</a>, describes VALUE as a pointer to any RClass or RObject value in Ruby. In CRuby, these structures are used to hold resources and information about objects or classes such as the instance variable count, <a href="http://inferior-products.com/docs/userdocs/ruby19/html/d7/da9/struct_r_object.html">numiv</a>, or a pointer to an array of instance variables, <a href="http://inferior-products.com/docs/userdocs/ruby19/html/d7/da9/struct_r_object.html">ivptr</a>. RClass and RObject structures also contain an inner structure called RBasic which holds additional information about the object, most importantly the <a href="http://inferior-products.com/docs/userdocs/ruby19/html/d7/da9/struct_r_object.html">klass pointer</a>. All of these are used by Ruby to help build object and class templates.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">RObject</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">RBasic</span> <span class="n">basic</span><span class="p">;</span>
    <span class="k">union</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
	    <span class="kt">uint32_t</span> <span class="n">numiv</span><span class="p">;</span>
	    <span class="n">VALUE</span> <span class="o">*</span><span class="n">ivptr</span><span class="p">;</span>
            <span class="kt">void</span> <span class="o">*</span><span class="n">iv_index_tbl</span><span class="p">;</span> <span class="cm">/* shortcut for RCLASS_IV_INDEX_TBL(rb_obj_class(obj)) */</span>
	<span class="p">}</span> <span class="n">heap</span><span class="p">;</span>
	<span class="n">VALUE</span> <span class="n">ary</span><span class="p">[</span><span class="n">ROBJECT_EMBED_LEN_MAX</span><span class="p">];</span>
    <span class="p">}</span> <span class="n">as</span><span class="p">;</span>
<span class="p">};</span></code></pre></figure>

<p>Another interesting fact about VALUE is how it’s represented internally by CRuby. While most of the time using a pointer data type would be the best solution, instead VALUE is represented as an unsigned long. Because on most computer platforms, <code class="highlighter-rouge">sizeof(void *)</code> is equal to <code class="highlighter-rouge">sizeof(long)</code>, this representation is not an issue. The main purpose of the pointer continues to be holding the memory address of the structure on the heap, however, by using the unsigned long data type, Ruby is able to leverage performance benefits. Smaller data types such as <a href="http://archive.oreilly.com/pub/post/the_ruby_value_1.html">nil, symbols, true, false, and small integers are saved directly to VALUE</a>. Ruby remembers these classes using a series of bit flags saved in the first few bits of VALUE. This means that these classes are saved on the stack instead of the normal place where CRuby stores them, the heap.</p>

<p><span class="">
  <img src="http://i1368.photobucket.com/albums/ag177/Matt_Michnal/2__ruby_zps51pby4fp.png" />
</span></p>

<p>When working with objects in Ruby, other than the smaller class types, the VALUE pointer is used as a reference to CRuby class data structures. Because information in objects has a longer lifespan and more complicated data, the actual data structure is saved on the heap and then VALUE is used to hold its memory address. When the VALUE is no longer referenced in Ruby code, it will remove the memory address from storage, making the structure on the heap ready for garbage collection. This is illustrated below with a simple RObject structure:</p>

<p><span class="">
  <img src="http://i1368.photobucket.com/albums/ag177/Matt_Michnal/heapstack_zpsa0yqblmn.png" />
</span></p>

<p>I hope this information helps when trying to follow <a href="http://stabbyproc.com/tags/#cruby">my series of CRuby source code posts</a>!</p>

    <a class="twitter-follow-button" href="https://twitter.com/mgm702" data-show-count=false>Follow @mgm702</a>
</article>


<div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'stabbyproccom'; // required: replace example with your forum shortname
        var disqus_developer = 1; // Comment out when the site is live
        var disqus_identifier = "/ruby/value-pointer-in-cruby.html";

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


      </main>

      <footer class="footer">
  <ul class="category-list">
    <li class="category-list">
      <a href ="/categories#ruby">Ruby</a>
      <a href ="/categories#ubuntu">Ubuntu</a>
      <a href ="/categories#vim">Vim</a>
    </li>
  </ul>
  <ul class="archive-list">
    <li class="archive-link">
      <a href ="/about">About</a>
      <a href="/archive">Archive</a>
    </li>
  </ul>

  <br/>
  <div class="footer-copyright">
    <small>
    &copy; <time datetime="2017-04-05T00:09:50-06:00">2017</time> StabbyProc.com All rights reserved.
    </small>
  </div>
</footer>

<script src="/js/twitter.js" type="text/javascript"></script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-83001023-1', 'auto');
  ga('send', 'pageview');

</script>


    </div>

  </body>
</html>
