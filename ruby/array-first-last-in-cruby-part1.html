<default!DOCTYPE html>
<html lang="en">
    <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
    
      Array's First and Last method in CRuby Source Code - Part 1 &middot; Stabby Proc
    
  </title>

  <link href='https://fonts.googleapis.com/css?family=Ubuntu' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Inconsolata:700' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="https://cdn.rawgit.com/konpa/devicon/master/devicon.min.css">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?">

  <link rel="alternate" type="application/atom+xml" title="Stabby Proc" href="/atom.xml">
</head>

  <body>
    <div class="container content">
      <header class="masthead">
        <h2 class="masthead-title">
          <a href="/" title="Home">
            <img src="/public/stabby-proc-logo.png"/>
          </a>
        </h2>
        <span class="tagline">- "Taking a stab at this thing called blogging!"</span>
      </header>

      <main>
      <article class="post">
  <h1 class="post-title">Array's First and Last method in CRuby Source Code - Part 1</h1>
    <sub class="article-date">Feb-23-2017</sub>
    <div class="post-tags-list">
      <ul>
        
        <li><a href="http://stabbyproc.com/tags#cruby" class="post-tag">cruby</a></li>
        
        <li><a href="http://stabbyproc.com/tags#ruby-arrays" class="post-tag">ruby-arrays</a></li>
        
        <li><a href="http://stabbyproc.com/tags#rarray" class="post-tag">rarray</a></li>
        
        <li><a href="http://stabbyproc.com/tags#mri" class="post-tag">mri</a></li>
        
      </ul>
    </div>
    <p>The first area of Ruby source code that I want to discuss is the array data structure. The reason I want to begin with array data structure is because of the similar nature in which C and Ruby arrays operate. It’s also fascinating to see how C data structures are used and transformed in order to provide helper functions in Ruby that aren’t built into the core of C programming. However, before talking about the functions in Ruby, we first have to discuss how arrays are represented in MRI.</p>

<p>in CRuby, the <code class="highlighter-rouge">RArray</code> structure is used to represent each array you create in Ruby. Similar to other C structures in MRI, <code class="highlighter-rouge">RArray</code> holds the RBasic inner structure. This structure holds the klass pointer and other information necessary for object creation. In addition to basic object values, <code class="highlighter-rouge">RArray</code> holds important information about array allocation and management. Some of these values include the long variable <code class="highlighter-rouge">len</code>, which holds the number of values saved to the array, <code class="highlighter-rouge">ptr</code>, which is a pointer to a memory segment CRuby allocates individually in order to save array elements, and <code class="highlighter-rouge">shared</code>, which represents data that is consolidated between multiple arrays. All of these can be seen below in the <code class="highlighter-rouge">RArray</code> structure definition which can be found in your <code class="highlighter-rouge">ruby.h</code> file:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">RArray</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">RBasic</span> <span class="n">basic</span><span class="p">;</span>
    <span class="k">union</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
	    <span class="kt">long</span> <span class="n">len</span><span class="p">;</span>
	    <span class="k">union</span> <span class="p">{</span>
		<span class="kt">long</span> <span class="n">capa</span><span class="p">;</span>
		<span class="n">VALUE</span> <span class="n">shared</span><span class="p">;</span>
	    <span class="p">}</span> <span class="n">aux</span><span class="p">;</span>
	    <span class="k">const</span> <span class="n">VALUE</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">heap</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">VALUE</span> <span class="n">ary</span><span class="p">[</span><span class="n">RARRAY_EMBED_LEN_MAX</span><span class="p">];</span>
    <span class="p">}</span> <span class="n">as</span><span class="p">;</span>
<span class="p">};</span></code></pre></figure>

<p>Now that you have an understanding about how the array object is created in Ruby, we can now talk about how CRuby creates the functions that make Ruby such an amazing language. I’ve decided that the first two methods I’m going to look at are simple and useful for finding elements in an array, <a href="https://ruby-doc.org/core-2.4.0/Array.html#method-i-first">Array#first</a> and <a href="https://ruby-doc.org/core-2.4.0/Array.html#method-i-last">Array#last</a>. Both of these functions are easy to understand in terms of their purpose and how to implement them. However, I can’t tell you how many times throughout my day I use these methods when working with array objects. They are functions that Ruby programmers take for granted so let’s take a look at how these functions are implemented under the hood.</p>

<p>The first thing I did in order to <a href="http://stabbyproc.com/ruby/tools-being-used-for-c-ruby-inspection.html">inspect these functions was open up the pry REPL program</a> and use the <code class="highlighter-rouge">show-source</code> method. I was able to pull both methods from the source code and they’re both shown below:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">show</span><span class="o">-</span><span class="n">source</span> <span class="n">Array</span><span class="err">#</span><span class="n">last</span>

<span class="n">From</span><span class="o">:</span> <span class="n">array</span><span class="p">.</span><span class="n">c</span> <span class="p">(</span><span class="n">C</span> <span class="n">Method</span><span class="p">)</span><span class="o">:</span>
<span class="n">Owner</span><span class="o">:</span> <span class="n">Array</span>
<span class="n">Visibility</span><span class="o">:</span> <span class="n">public</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">lines</span><span class="o">:</span> <span class="mi">12</span>

<span class="n">VALUE</span> <span class="n">rb_ary_last</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="n">VALUE</span> <span class="o">*</span><span class="n">argv</span><span class="p">,</span> <span class="n">VALUE</span> <span class="n">ary</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">long</span> <span class="n">len</span> <span class="o">=</span> <span class="n">RARRAY_LEN</span><span class="p">(</span><span class="n">ary</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">Qnil</span><span class="p">;</span>
      <span class="k">return</span> <span class="n">RARRAY_AREF</span><span class="p">(</span><span class="n">ary</span><span class="p">,</span> <span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">ary_take_first_or_last</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">ary</span><span class="p">,</span> <span class="n">ARY_TAKE_LAST</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>And here’s the <a href="https://ruby-doc.org/core-2.4.0/Array.html#method-i-first">Array#first</a> method in CRuby:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">show</span><span class="o">-</span><span class="n">source</span> <span class="n">Array</span><span class="err">#</span><span class="n">first</span>

<span class="n">From</span><span class="o">:</span> <span class="n">array</span><span class="p">.</span><span class="n">c</span> <span class="p">(</span><span class="n">C</span> <span class="n">Method</span><span class="p">)</span><span class="o">:</span>
<span class="n">Owner</span><span class="o">:</span> <span class="n">Array</span>
<span class="n">Visibility</span><span class="o">:</span> <span class="n">public</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">lines</span><span class="o">:</span> <span class="mi">11</span>

<span class="k">static</span> <span class="n">VALUE</span> <span class="n">rb_ary_first</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">VALUE</span> <span class="o">*</span><span class="n">argv</span><span class="p">,</span> <span class="n">VALUE</span> <span class="n">ary</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">RARRAY_LEN</span><span class="p">(</span><span class="n">ary</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">Qnil</span><span class="p">;</span>
      <span class="k">return</span> <span class="n">RARRAY_AREF</span><span class="p">(</span><span class="n">ary</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">ary_take_first_or_last</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">ary</span><span class="p">,</span> <span class="n">ARY_TAKE_FIRST</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>As you can see, both of these functions have a lot of similarities. They take the same values in each and they both return a <a href="http://stabbyproc.com/ruby/value-pointer-in-cruby.html">VALUE pointer</a>, which represents the new array value returned from the function. These methods also check to make sure that the array length is greater than zero, otherwise <code class="highlighter-rouge">Qnil</code> is returned. Finally, both functions are similar in that they call the <code class="highlighter-rouge">ary_take_first_or_last</code> method if the array wants to return more than just one object from the list. However, before I talk about that function I want to cover how each method returns a single object from either the front or the end of the array.</p>

<p>In <a href="https://ruby-doc.org/core-2.4.0/Array.html#method-i-first">Array#first</a> the method first checks to see if the <a href="http://crasseux.com/books/ctutorial/argc-and-argv.html">argc</a> variable is equal to 0. That means that the Ruby program doesn’t want to return anything more than the first value from the array. Afterwards, the function checks to see if the length of the array is greater than zero. If it’s not, then the function returns the nil value, <code class="highlighter-rouge">Qnil</code>. If the array length is greater than zero though, then the function calls to <code class="highlighter-rouge">RARRAY_AREF</code> with the array and value that needs to be returned. In this case, that value is 0 because we want the first element in the array.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c">  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">RARRAY_LEN</span><span class="p">(</span><span class="n">ary</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">Qnil</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">RARRAY_AREF</span><span class="p">(</span><span class="n">ary</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span></code></pre></figure>

<p>The functionality is very similar when working with <a href="https://ruby-doc.org/core-2.4.0/Array.html#method-i-last">Array#last</a>. The only difference is the value that needs to be returned from the array. I found this part of the function very interesting because I was wondering how C arrays would handle returning the last value from an array, since there’s no natural way for the data structure to do so. However, in CRuby, we leverage the <code class="highlighter-rouge">RArray</code> structure variable, <code class="highlighter-rouge">len</code>, which holds the Ruby array’s length. Finally, we pass this along to the <code class="highlighter-rouge">RARRAY_AREF</code> function where the single value is returned.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c">  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">long</span> <span class="n">len</span> <span class="o">=</span> <span class="n">RARRAY_LEN</span><span class="p">(</span><span class="n">ary</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">Qnil</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">RARRAY_AREF</span><span class="p">(</span><span class="n">ary</span><span class="p">,</span> <span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span></code></pre></figure>

<p><code class="highlighter-rouge">RARRAY_AREF</code> is a preprocessor function which returns an array value based on the <code class="highlighter-rouge">i</code> input variable. You can see this in the code below because of the square brackets and reference to the <code class="highlighter-rouge">RARRAY_CONST_PTR</code> function. This function returns the constant <code class="highlighter-rouge">VALUE</code> pointer to the <code class="highlighter-rouge">RArray</code> structure passed into the function and using the brackets means that we are returning an array with a single value back to Ruby.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c">  <span class="cp">#ifndef RARRAY_AREF
</span>  <span class="cp"># define RARRAY_AREF(a, i) (RARRAY_CONST_PTR(a)[i])
</span>  <span class="cp">#endif</span></code></pre></figure>

<p>And that’s it. Both <a href="https://ruby-doc.org/core-2.4.0/Array.html#method-i-first">Array#first</a> and <a href="https://ruby-doc.org/core-2.4.0/Array.html#method-i-last">Array#last</a> pass their functionality to this function in order to return the necessary value from the array. In the next post I will cover how both these Ruby functions return multiple values from the array, including an in depth look at the <code class="highlighter-rouge">ary_take_first_or_last</code> function.</p>

    <a class="twitter-follow-button" href="https://twitter.com/mgm702" data-show-count=false>Follow @mgm702</a>
</article>


<div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'stabbyproccom'; // required: replace example with your forum shortname
        var disqus_developer = 1; // Comment out when the site is live
        var disqus_identifier = "/ruby/array-first-last-in-cruby-part1.html";

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


      </main>

      <footer class="footer">
  <ul class="category-list">
    <li class="category-list">
      <a href ="/categories#ruby">Ruby</a>
      <a href ="/categories#ubuntu">Ubuntu</a>
      <a href ="/categories#vim">Vim</a>
    </li>
  </ul>
  <ul class="archive-list">
    <li class="archive-link">
      <a href ="/about">About</a>
      <a href="/archive">Archive</a>
    </li>
  </ul>

  <br/>
  <div class="footer-copyright">
    <small>
    &copy; <time datetime="2017-04-05T00:09:50-06:00">2017</time> StabbyProc.com All rights reserved.
    </small>
  </div>
</footer>

<script src="/js/twitter.js" type="text/javascript"></script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-83001023-1', 'auto');
  ga('send', 'pageview');

</script>


    </div>

  </body>
</html>
